<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>I Love Lamp – iCUE-safe (Custom Color Picker)</title>
  <style>
    :root{
      --glow-r: 255; --glow-g: 184; --glow-b: 79;
      --brightness: 70;
      --glow-deg: 90deg;
      --rib-opacity: 0.25;
      --rib-angle: 90deg;
      --bg-color:#121212; --text-color:#e9e9e9; --panel-bg:#1e1e1e; --muted:#b7b7b7;
      --edge-dark: 24,24,28; --glass-tint: 255,255,255;
      --noise-opacity:.08; --corner: 28px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; margin:0; }
    body{ background:var(--bg-color); color:var(--text-color);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      transition: background .3s ease, color .3s ease; }
    body.light{ --bg-color:#e9e6e3; --text-color:#1f2328; --panel-bg:#ffffff; --muted:#59636e; }

    .page{ position:relative; height:100%; }
    .frame{ position:absolute; inset:0; border-radius:var(--corner); overflow:hidden; background:transparent; }
    .glass{ position:absolute; inset:0; border-radius:inherit; background:
      radial-gradient(120% 100% at -10% 50%, rgba(var(--edge-dark), .18), transparent 45%),
      radial-gradient(120% 100% at 110% 50%, rgba(var(--edge-dark), .18), transparent 45%),
      linear-gradient(180deg, rgba(var(--glass-tint),.5), rgba(var(--glass-tint),.35)); }
    .ribs{ position:absolute; inset:0; border-radius:inherit; pointer-events:none; background:
      repeating-linear-gradient(var(--rib-angle), rgba(255,255,255, calc(var(--rib-opacity)*.35)) 0 1px,
      rgba(200,200,210, calc(var(--rib-opacity)*.35)) 1px 2px, rgba(150,150,160,0) 2px 5px); opacity:.9; }
    .grain{ position:absolute; inset:0; border-radius:inherit; pointer-events:none; }
    .grain::before{ content:""; position:absolute; inset:-50%;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300" viewBox="0 0 300 300"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.45"/></svg>');
      background-size:300px 300px; opacity:var(--noise-opacity); mix-blend-mode:soft-light; }

    /* Uniform glow */
    .glow{ position:absolute; inset: clamp(6px, 7vmin, 64px); border-radius: calc(var(--corner)*.6);
      filter: blur(calc(8px + (var(--brightness)/100 * 18px)));
      background:
        radial-gradient(closest-side at 50% 50%, rgba(var(--glow-r), var(--glow-g), var(--glow-b), calc(var(--brightness)/85)) 0%, rgba(var(--glow-r), var(--glow-g), var(--glow-b), calc(var(--brightness)/140)) 55%, rgba(var(--glow-r), var(--glow-g), var(--glow-b), 0) 100%),
        radial-gradient(120% 120% at 50% 50%, rgba(var(--glow-r), var(--glow-g), var(--glow-b), calc(var(--brightness)/220)) 0%, rgba(0,0,0,0) 70%),
        linear-gradient(var(--glow-deg), rgba(var(--glow-r), var(--glow-g), var(--glow-b), calc(var(--brightness)/300)) 35%, rgba(0,0,0,0) 65%);
      box-shadow:
        0 0 calc(25px + 55px * (var(--brightness)/100)) rgba(var(--glow-r), var(--glow-g), var(--glow-b), calc(var(--brightness)/130)),
        0 0 calc(60px + 120px * (var(--brightness)/100)) rgba(var(--glow-r), var(--glow-g), var(--glow-b), calc(var(--brightness)/320));
      mix-blend-mode: screen;
    }

    /* Panel */
    .panel{ position:fixed; right:20px; top:20px; bottom:20px; width: clamp(260px, 26vw, 380px); z-index:5;
      background:var(--panel-bg); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.1);
      display:flex; flex-direction:column; padding:14px; gap:12px; transform: translateX(0); transition: transform .35s ease; overflow:hidden; }
    .panel h2{ margin-left:28px; }
    .panel.collapsed{ transform: translateX(calc(100% + 24px)); }
    .panel-scroll{ overflow:auto; padding:6px 2px 10px; }
    .collapse-btn{ position:absolute; left:10px; top:10px; border:0; border-radius:8px; padding:6px 10px; font-weight:700; cursor:pointer; background:#2c2c2c; color:#fff; z-index:10; }
    .menu-tab{ position:fixed; right:12px; top:50%; transform:translateY(-50%); border:0; border-radius:12px; padding:10px 12px; font-weight:700; cursor:pointer; background:#2c2c2c; color:#fff; box-shadow:0 8px 20px rgba(0,0,0,.25); display:none; z-index:6; }
    .panel.collapsed + .menu-tab{ display:block; }

    .toggle-btn{ cursor:pointer; border:none; border-radius:8px; padding:8px 12px; font-weight:600; background:#333; color:#fff; }
    .row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
    .subgrid{ display:grid; gap:8px; }
    .pill{ display:flex; gap:8px; background:#444; padding:6px; border-radius:999px; width:max-content; }
    .pill button{ border:0; background:transparent; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; color:#ddd; }
    .pill button[aria-pressed="true"]{ background:#222; color:#fff; }
    input[type="range"]{ width:100%; }
    .inline{ display:flex; align-items:center; gap:10px; }
    .swatch{ width:28px; height:28px; border-radius:8px; box-shadow: inset 0 0 0 1px rgba(0,0,0,.12); }
    .muted{ color:var(--muted); font-size:.92rem; }
    .credit{ margin-top:8px; font-size:.9rem; opacity:.85; text-align:center; }
    .credit a{ color:inherit; font-weight:700; text-decoration:none; }

    /* Custom color picker */
    .picker{ display:grid; gap:10px; }
    .sv-wrap{ position:relative; width:100%; aspect-ratio: 4/3; border-radius:10px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(0,0,0,.2); }
    .sv{ position:absolute; inset:0; }
    .sv .grad-white{ position:absolute; inset:0; background: linear-gradient(90deg, #fff, rgba(255,255,255,0)); }
    .sv .grad-black{ position:absolute; inset:0; background: linear-gradient(0deg, #000, rgba(0,0,0,0)); }
    .sv-cursor{ position:absolute; width:16px; height:16px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 0 1px rgba(0,0,0,.5); transform: translate(-50%,-50%); pointer-events:none; }
    .hue{ -webkit-appearance:none; appearance:none; height:12px; border-radius:999px; outline:none; }
    /* Hue gradient (no images) */
    .hue{ background: linear-gradient(90deg,
      #ff0000 0%, #ffff00 17%, #00ff00 33%, #00ffff 50%,
      #0000ff 67%, #ff00ff 83%, #ff0000 100%); }
    .hue::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%; background:#fff; box-shadow:0 0 0 1px rgba(0,0,0,.4); cursor:pointer; }
    .hue::-moz-range-thumb{ width:18px; height:18px; border-radius:50%; background:#fff; border:0; box-shadow:0 0 0 1px rgba(0,0,0,.4); cursor:pointer; }

    @media (max-width: 700px){
      .panel{ left:20px; right:20px; width:auto; top:auto; bottom:20px; height:min(70vh,520px); transform: translateY(0); }
      .panel.collapsed{ transform: translateY(calc(100% + 24px)); }
      .menu-tab{ top:auto; bottom:24px; right:24px; transform:none; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="frame" id="lampFrame">
      <div class="glass"></div>
      <div class="ribs" id="ribs"></div>
      <div class="grain"></div>
      <div class="glow" id="glow"></div>
    </div>

    <aside class="panel" id="panel">
      <button class="collapse-btn" id="collapseBtn" title="Hide controls">⇢</button>
      <div class="panel-scroll">
        <div class="row">
          <h2>Lamp Controls</h2>
          <button class="toggle-btn" id="themeBtn" aria-pressed="false">Dark Mode</button>
        </div>

        <div class="subgrid" style="margin-top:6px;">
          <div class="pill" role="tablist" aria-label="Color Mode">
            <button id="modeRGB" role="tab" aria-selected="true" aria-pressed="true">RGB</button>
            <button id="modeWhite" role="tab" aria-selected="false" aria-pressed="false">White</button>
          </div>

          <!-- RGB (custom picker) -->
          <div id="rgbControls" class="subgrid">
            <div class="row">
              <label>Color</label>
              <div class="inline"><div class="swatch" id="swatch"></div></div>
            </div>

            <div class="picker">
              <div class="sv-wrap" id="svWrap" aria-label="Saturation/Value control">
                <div class="sv" id="sv">
                  <div class="grad-white"></div>
                  <div class="grad-black"></div>
                </div>
                <div class="sv-cursor" id="svCursor"></div>
              </div>
              <input class="hue" id="hue" type="range" min="0" max="360" value="40" aria-label="Hue" />
            </div>

            <!-- Optional synced RGB sliders -->
            <div class="subgrid" style="margin-top:8px;">
              <div class="row"><label for="rSlider">Red</label><span id="rVal" class="muted">255</span></div>
              <input id="rSlider" type="range" min="0" max="255" value="255" />
              <div class="row"><label for="gSlider">Green</label><span id="gVal" class="muted">184</span></div>
              <input id="gSlider" type="range" min="0" max="255" value="184" />
              <div class="row"><label for="bSlider">Blue</label><span id="bValRGB" class="muted">79</span></div>
              <input id="bSlider" type="range" min="0" max="255" value="79" />
            </div>
          </div>

          <!-- White mode -->
          <div id="whiteControls" class="subgrid" style="display:none;">
            <div class="row">
              <label for="whiteSlider">White tone</label>
              <span class="muted" id="whiteLabel">Cold</span>
            </div>
            <input id="whiteSlider" type="range" min="0" max="100" value="0" />
            <div class="muted" aria-hidden="true" style="display:flex; justify-content:space-between; font-size:.85rem; margin-top:-4px;">
              <span>Cold</span><span>Warm</span><span>Warmest</span>
            </div>
          </div>

          <div class="row" style="margin-top:6px;">
            <label for="brightness">Brightness</label>
            <span id="bVal" class="muted">70</span>
          </div>
          <input id="brightness" type="range" min="0" max="100" value="70" />

          <div class="row" style="margin-top:6px;">
            <label for="frost">Frost (ribbing)</label>
            <span id="fVal" class="muted">25%</span>
          </div>
          <input id="frost" type="range" min="0" max="100" value="25" />

          <div class="credit">I Love Lamp by
            <a href="https://opulent-hardware.github.io/-I-love-lamp/" target="_blank" rel="noreferrer noopener">OPULENT HARDWARE</a>
          </div>
        </div>
      </div>
    </aside>
    <button class="menu-tab" id="menuTab" title="Show controls">☰ Menu</button>
  </div>

  <script>
    /* --- Utilities --- */
    const setCSSVar = (n, v) => document.documentElement.style.setProperty(n, v);
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

    // HSV<->RGB helpers
    function hsvToRgb(h, s, v){
      s/=100; v/=100;
      const c = v * s;
      const x = c * (1 - Math.abs(((h/60) % 2) - 1));
      const m = v - c;
      let r=0,g=0,b=0;
      if (0<=h && h<60){ r=c; g=x; b=0; }
      else if (60<=h && h<120){ r=x; g=c; b=0; }
      else if (120<=h && h<180){ r=0; g=c; b=x; }
      else if (180<=h && h<240){ r=0; g=x; b=c; }
      else if (240<=h && h<300){ r=x; g=0; b=c; }
      else { r=c; g=0; b=x; }
      return { r: Math.round((r+m)*255), g: Math.round((g+m)*255), b: Math.round((b+m)*255) };
    }
    function rgbToHsv(r,g,b){
      r/=255; g/=255; b/=255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b);
      const d = max - min;
      let h;
      if (d === 0) h = 0;
      else if (max === r) h = 60 * (((g-b)/d) % 6);
      else if (max === g) h = 60 * (((b-r)/d) + 2);
      else h = 60 * (((r-g)/d) + 4);
      if (h < 0) h += 360;
      const s = max === 0 ? 0 : (d / max);
      const v = max;
      return { h: Math.round(h), s: Math.round(s*100), v: Math.round(v*100) };
    }

    function applyRGB({r,g,b}){
      setCSSVar('--glow-r', r);
      setCSSVar('--glow-g', g);
      setCSSVar('--glow-b', b);
      swatch.style.background = `rgb(${r},${g},${b})`;
      // sync numeric labels
      rVal.textContent = r; gVal.textContent = g; bValRGB.textContent = b;
      rSlider.value = r; gSlider.value = g; bSlider.value = b;
    }

    function kelvinToRGB(k){
      let t=k/100,r,g,b;
      if (t<=66) r=255; else { r=t-60; r=329.698727446*Math.pow(r,-0.1332047592); r=Math.min(255,Math.max(0,r)); }
      if (t<=66) { g=99.4708025861*Math.log(t)-161.1195681661; }
      else { g=t-60; g=288.1221695283*Math.pow(g,-0.0755148492); }
      g=Math.min(255,Math.max(0,g));
      if (t>=66) b=255; else if (t<=19) b=0; else { b=138.5177312231*Math.log(t-10)-305.0447927307; b=Math.min(255,Math.max(0,b)); }
      return { r:Math.round(r), g:Math.round(g), b:Math.round(b) };
    }

    /* --- DOM refs --- */
    const frame = document.getElementById('lampFrame');
    const ribs = document.getElementById('ribs');
    const glow = document.getElementById('glow');

    const panel = document.getElementById('panel');
    const collapseBtn = document.getElementById('collapseBtn');
    const menuTab = document.getElementById('menuTab');
    const themeBtn = document.getElementById('themeBtn');

    const brightness = document.getElementById('brightness');
    const bVal = document.getElementById('bVal');
    const frost = document.getElementById('frost');
    const fVal = document.getElementById('fVal');

    const modeRGB = document.getElementById('modeRGB');
    const modeWhite = document.getElementById('modeWhite');
    const rgbControls = document.getElementById('rgbControls');
    const whiteControls = document.getElementById('whiteControls');

    const swatch = document.getElementById('swatch');
    const whiteSlider = document.getElementById('whiteSlider');
    const whiteLabel = document.getElementById('whiteLabel');

    // Custom picker refs
    const hue = document.getElementById('hue');
    const svWrap = document.getElementById('svWrap');
    const sv = document.getElementById('sv');
    const svCursor = document.getElementById('svCursor');

    const rSlider = document.getElementById('rSlider');
    const gSlider = document.getElementById('gSlider');
    const bSlider = document.getElementById('bSlider');
    const rVal = document.getElementById('rVal');
    const gVal = document.getElementById('gVal');
    const bValRGB = document.getElementById('bValRGB');

    // State: HSV drives the picker
    let H = 40, S = 40, V = 90;

    function setSVBackground(){
      // Hue-colored base for SV square
      const {r,g,b} = hsvToRgb(H,100,100);
      sv.style.background = `rgb(${r},${g},${b})`;
    }
    function paintFromHSV(){
      setSVBackground();
      const {r,g,b} = hsvToRgb(H,S,V);
      applyRGB({r,g,b});
      // move cursor
      const rect = svWrap.getBoundingClientRect();
      const x = (S/100)*rect.width;
      const y = ((100-V)/100)*rect.height;
      svCursor.style.left = x+'px';
      svCursor.style.top = y+'px';
      hue.value = H;
    }

    function onHueInput(e){
      H = +e.target.value;
      paintFromHSV();
    }

    function svFromEvent(clientX, clientY){
      const rect = svWrap.getBoundingClientRect();
      const x = clamp(clientX - rect.left, 0, rect.width);
      const y = clamp(clientY - rect.top, 0, rect.height);
      S = Math.round((x/rect.width)*100);
      V = Math.round(100 - (y/rect.height)*100);
      paintFromHSV();
    }

    // SV pointer interactions
    let dragging = false;
    const startSV = (e)=>{
      dragging = true;
      const pt = ('touches' in e) ? e.touches[0] : e;
      svFromEvent(pt.clientX, pt.clientY);
      e.preventDefault();
    };
    const moveSV = (e)=>{
      if(!dragging) return;
      const pt = ('touches' in e) ? e.touches[0] : e;
      svFromEvent(pt.clientX, pt.clientY);
    };
    const endSV = ()=> dragging = false;

    svWrap.addEventListener('mousedown', startSV);
    svWrap.addEventListener('touchstart', startSV, {passive:false});
    window.addEventListener('mousemove', moveSV);
    window.addEventListener('touchmove', moveSV, {passive:false});
    window.addEventListener('mouseup', endSV);
    window.addEventListener('touchend', endSV);

    hue.addEventListener('input', onHueInput);
    hue.addEventListener('change', onHueInput);

    // Sync from RGB sliders
    function fromRgbSliders(){
      const r = +rSlider.value, g = +gSlider.value, b = +bSlider.value;
      const {h,s,v} = rgbToHsv(r,g,b);
      H = h; S = s; V = v;
      paintFromHSV();
    }
    rSlider.addEventListener('input', fromRgbSliders);
    gSlider.addEventListener('input', fromRgbSliders);
    bSlider.addEventListener('input', fromRgbSliders);

    // Brightness/Frost/Orientation
    function updateBrightness(v){ setCSSVar('--brightness', v); bVal.textContent = v; }
    function updateFrost(v){ setCSSVar('--rib-opacity', (v/100).toFixed(3)); fVal.textContent = v + '%'; }
    function updateOrientation(){
      const rect = frame.getBoundingClientRect();
      const longestIsWidth = rect.width >= rect.height;
      const deg = longestIsWidth ? 90 : 0;
      setCSSVar('--glow-deg', deg + 'deg');
      setCSSVar('--rib-angle', deg + 'deg');
    }
    const ro = new ResizeObserver(updateOrientation); ro.observe(frame);
    window.addEventListener('orientationchange', updateOrientation);
    window.addEventListener('load', updateOrientation);

    brightness.addEventListener('input', e => updateBrightness(e.target.value));
    frost.addEventListener('input', e => updateFrost(e.target.value));

    // Mode switching
    function setModeRGB(){
      modeRGB.setAttribute('aria-pressed','true');
      modeWhite.setAttribute('aria-pressed','false');
      rgbControls.style.display = '';
      whiteControls.style.display = 'none';
    }
    function setModeWhite(){
      modeRGB.setAttribute('aria-pressed','false');
      modeWhite.setAttribute('aria-pressed','true');
      rgbControls.style.display = 'none';
      whiteControls.style.display = '';
      // map 0..100 -> 6500K .. 2000K
      const v = +whiteSlider.value;
      const k = 6500 - (4500 * (v/100));
      const {r,g,b} = kelvinToRGB(k);
      applyRGB({r,g,b});
      whiteLabel.textContent = v < 15 ? 'Cold' : (v > 85 ? 'Warmest' : 'Warm');
    }
    modeRGB.addEventListener('click', setModeRGB);
    modeWhite.addEventListener('click', setModeWhite);
    whiteSlider.addEventListener('input', ()=> setModeWhite());

    // Theme + panel
    themeBtn.addEventListener('click', ()=>{
      const isLight = document.body.classList.toggle('light');
      themeBtn.textContent = isLight ? 'Light Mode' : 'Dark Mode';
      themeBtn.setAttribute('aria-pressed', String(isLight));
    });
    collapseBtn.addEventListener('click', ()=> panel.classList.add('collapsed'));
    menuTab.addEventListener('click', ()=> panel.classList.remove('collapsed'));

    // Init
    (function init(){
      updateOrientation();
      updateBrightness(brightness.value);
      updateFrost(frost.value);
      paintFromHSV(); // paints swatch + rgb sliders
      setModeRGB();   // default mode
    })();
  </script>
</body>
</html>
